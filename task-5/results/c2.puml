@startuml
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(user, "Сотрудник склада", "Загружает CSV и смотрит статус")

System_Boundary(sys, "ETL System") {
  Container(web, "Frontend (Angular)", "Browser/WebSockets", "UI для загрузки и статусов")
  Container(mon, "Монолит ERP", "Java 11 / WildFly", "Приём CSV, первичная валидация, запись в GCS, обратные уведомления")
  Container(etl, "ETL (Spring Batch)", "Spring Boot 3 + Spring Batch", "Чтение CSV из GCS, валидация, обогащение, staging+merge, метрики")
  ContainerDb(pg, "PostgreSQL", "SQL", "Доменные таблицы + staging + Batch JobRepository")
  Container_Ext(gcs, "GCS", "Object Storage", "Хранение исходных и обработанных CSV")

  Container(prometheus, "Prometheus", "Time‑series DB", "Чтение и хранение метрик")
  Container(grafana, "Grafana", "Dashboards", "Визуализация метрик")
  Container(filebeat, "Filebeat", "Log shipper (Beats)", "Сбор логов")
  Container(logstash, "Logstash", "Ingest pipeline", "Парсинг/обогощение логов")
  Container(elasticsearch, "Elasticsearch", "Search engine", "Хранение логов для Kibana")
  Container(kibana, "Kibana", "Dashboards", "Визуализация логов")
}

Rel(user, web, "Загрузка файла / просмотр статуса")
Rel(web, mon, "POST /upload (CSV)")
Rel(mon, gcs, "PUT object (CSV)")
Rel(mon, etl, "Запуск Job (REST/PubSub)")
Rel(etl, gcs, "GET object (CSV)")
Rel(etl, pg, "Request", "JDBC")
Rel(etl, mon, "Callback статуса / Webhook")

Rel(etl, prometheus, "Expose metrics", "/actuator/prometheus")
Rel(grafana, prometheus, "Queries metrics", "HTTP/PromQL")

Rel(filebeat, logstash, "Ships logs", "Beats (tcp/5044)")
Rel(logstash, elasticsearch, "Writes logs", "HTTP/9200")
Rel(kibana, elasticsearch, "Queries logs", "HTTP")

Rel(etl, filebeat, "Writes logs", "json-file driver")

@enduml